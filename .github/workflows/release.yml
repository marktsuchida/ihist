# This file is part of ihist
# Copyright 2025 Board of Regents of the University of Wisconsin System
# SPDX-License-Identifier: MIT

name: Release

on:
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  tag-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.14

      - name: Compute versions
        id: versions
        run: |
          set -euo pipefail
          CURRENT=$(uvx meson rewrite kwargs info project / | jq -r '.kwargs["project#/"].version')
          RELEASE=${CURRENT%.dev0}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$RELEASE"
          if [[ -z "$MAJOR" || -z "$MINOR" || -z "$PATCH" ]]; then
            echo "Error: Failed to parse version '$RELEASE' as MAJOR.MINOR.PATCH"
            exit 1
          fi
          if ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "Error: PATCH version '$PATCH' is not a number"
            exit 1
          fi
          NEXT="$MAJOR.$MINOR.$((PATCH + 1)).dev0"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "release=$RELEASE" >> "$GITHUB_OUTPUT"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Versions: current=$CURRENT release=$RELEASE next=$NEXT"

      - name: Validate preconditions
        run: |
          set -euo pipefail
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "Error: Releases must be created from main branch"
            exit 1
          fi
          if [[ "${{ steps.versions.outputs.current }}" != *.dev0 ]]; then
            echo "Error: Current version does not end with .dev0"
            exit 1
          fi
          if git rev-parse "v${{ steps.versions.outputs.release }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ steps.versions.outputs.release }} already exists"
            exit 1
          fi
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Error: Working directory has uncommitted changes"
            git status
            exit 1
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Note: This workflow requires github-actions[bot] to have permission to
      # push directly to main, bypassing any branch protection rules.
      - name: Create release commit and tag
        run: |
          set -euo pipefail
          uvx meson rewrite kwargs set project / version '${{ steps.versions.outputs.release }}'
          git add meson.build
          git commit -m 'Release ${{ steps.versions.outputs.release }}'
          git tag -a 'v${{ steps.versions.outputs.release }}' -m 'Release'

      - name: Bump to next dev version
        run: |
          set -euo pipefail
          uvx meson rewrite kwargs set project / version '${{ steps.versions.outputs.next }}'
          git add meson.build
          git commit -m 'Version back to dev'

      - name: Push commits and tag
        run: |
          set -euo pipefail
          git push origin HEAD
          git push origin "v${{ steps.versions.outputs.release }}"
